<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Shooter Dental - Resina vs Caries</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #050816;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: system-ui, sans-serif;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none; 
    }

    #game-wrapper {
      width: 420px;
      height: 720px;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.7);
      position: relative;
      background: radial-gradient(circle at top, #1e3b70, #050816);
    }

    /* üî•üî•üî• TEXTO EN EL FONDO üî•üî•üî• */
    #bg-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-0deg);
      width: 140%;
      text-align: center;
      font-size: 34px;
      font-weight: 900;
      color: rgba(219,206,33,0.5);
      letter-spacing: 2px;
      line-height: 1.2;
      pointer-events: none;
      z-index: 900;
      text-shadow: 0 0 12px rgba(255,255,255,0.04);
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    #hud {
      position: absolute;
      top: 6px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.8);
      z-index: 2;
    }

    #hint {
      position: absolute;
      bottom: 72px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      opacity: 0.8;
      z-index: 2;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }

    #touch-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      display: flex;
      z-index: 3;
      background: linear-gradient(to top, rgba(0,0,0,0.65), transparent);
    }

    .btn-touch {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      opacity: 0.85;
    }

    .btn-touch span {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(0,0,0,0.3);
    }

    #btn-shoot span {
      background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      color: #2d3436;
      border-color: rgba(0,0,0,0.4);
    }

    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 4;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      text-align: center;
      padding: 0 20px;
    }

    #overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #overlay h1 { margin-bottom: 8px; }
    #overlay p { margin-bottom: 14px; }

    #restart-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#00cec9,#0984e3);
      color: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }

    #restart-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
  <div id="bg-text">
      LunaLab Dent<br>
      te ayuda a cuidar<br>
	  tus dientes<br>
    </div>
	
    <canvas id="game" width="420" height="720"></canvas>

    <div id="hud">
      <div>Puntos: <strong id="score">0</strong></div>
      <div>Vidas: <strong id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</strong></div>
    </div>

    <div id="hint">
      Teclado: ‚Üê ‚Üí / A D &nbsp;¬∑&nbsp; ESPACIO dispara &nbsp;¬∑&nbsp; Tambi√©n t√°ctil abajo
    </div>

    <div id="touch-controls">
      <div class="btn-touch" id="btn-left"><span>‚óÄ</span></div>
      <div class="btn-touch" id="btn-shoot"><span>Disparar</span></div>
      <div class="btn-touch" id="btn-right"><span>‚ñ∂</span></div>
    </div>

    <div id="overlay">
      <h1 id="overlay-title">Game Over</h1>
      <p id="overlay-msg"></p>
      <button id="restart-btn">Volver a jugar</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayMsg = document.getElementById('overlay-msg');
    const restartBtn = document.getElementById('restart-btn');

    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnShoot = document.getElementById('btn-shoot');

    // ----- CONFIG -----
    const TEETH_COUNT = 6;
    const CAVITIES_PER_TOOTH = 3; // peque√±a, mediana, grande
    const TARGET_SCORE_PER_CAVITY = 10;
    const PLAYER_SPEED = 6;
    const BULLET_SPEED = 10;
    const LIVES_MAX = 3;
    const CARIE_MIN_SPEED = 1.6;
    const CARIE_MAX_SPEED = 2.4;
    const GLOBAL_SPAWN_INTERVAL = 900; // ms

    // ---- ESTADO ----
    let player;
    let bullets = [];
    let caries = [];
    let teeth = [];
    let keys = {};
    let moveLeft = false;
    let moveRight = false;
    let shooting = false;

    let score = 0;
    let lives = LIVES_MAX;
    let lastShoot = 0;
    let SHOOT_DELAY = 260;
    let lastGlobalSpawn = 0;
    let running = true;
    let lastTime = 0;

    // ----- MODELO DE DIENTES Y CARIES -----
    function createTeeth() {
      teeth = [];
      const baseY = canvas.height - 110;
      const totalWidth = canvas.width * 0.8;
      const toothWidth = totalWidth / TEETH_COUNT;
      const startX = (canvas.width - totalWidth) / 2 + toothWidth / 2;
      const toothHeight = 80;

      for (let i = 0; i < TEETH_COUNT; i++) {
        const x = startX + i * toothWidth;
        const cavities = [];

        const sizes = ['small', 'medium', 'large'];
        const offsets = [-10, 0, 10]; // horizontal dentro del diente

        for (let j = 0; j < CAVITIES_PER_TOOTH; j++) {
          cavities.push({
            size: sizes[j],
            filled: false,
            activeCarieId: null,
            offsetX: offsets[j]
          });
        }

        teeth.push({
          x,
          y: baseY,
          w: toothWidth * 0.8,
          h: toothHeight,
          cavities
        });
      }
    }

    // ----- JUGADOR -----
    function createPlayer() {
      player = {
        x: canvas.width / 2,
        y: canvas.height - 170, // encima de los dientes
        w: 40,
        h: 40
      };
    }

    // ----- HUD -----
    function updateHUD() {
      scoreEl.textContent = score;
      const full = '‚ù§Ô∏è'.repeat(lives);
      const empty = 'ü©∂'.repeat(Math.max(0, LIVES_MAX - lives));
      livesEl.textContent = full + empty;
    }

    // ----- BALAS -----
    function shoot(time) {
      if (time - lastShoot < SHOOT_DELAY) return;
      lastShoot = time;
      bullets.push({
        x: player.x,
        y: player.y - player.h / 2,
        r: 5,
        speed: BULLET_SPEED
      });
    }

    // ----- CARIES -----
    function getPendingCavities() {
      const pending = [];
      teeth.forEach((tooth, toothIndex) => {
        tooth.cavities.forEach((cavity, cavityIndex) => {
          if (!cavity.filled && cavity.activeCarieId === null) {
            pending.push({ toothIndex, cavityIndex });
          }
        });
      });
      return pending;
    }

    function spawnCarieForCavity(toothIndex, cavityIndex, time) {
      const tooth = teeth[toothIndex];
      const cavity = tooth.cavities[cavityIndex];

      const baseX = tooth.x + cavity.offsetX;
      const yStart = -40;
      const speed =
        CARIE_MIN_SPEED + Math.random() * (CARIE_MAX_SPEED - CARIE_MIN_SPEED);
      const amplitude = 15 + Math.random() * 10;
      const phase = Math.random() * Math.PI * 2;
      const radius = cavity.size === 'small'
        ? 10
        : cavity.size === 'medium'
        ? 13
        : 16;

      const id = Symbol('carie');

      caries.push({
        id,
        baseX,
        x: baseX,
        y: yStart,
        r: radius,
        speed,
        amp: amplitude,
        phase,
        toothIndex,
        cavityIndex
      });

      cavity.activeCarieId = id;
    }

    function trySpawnCarie(time) {
      if (time - lastGlobalSpawn < GLOBAL_SPAWN_INTERVAL) return;
      lastGlobalSpawn = time;

      const pending = getPendingCavities();
      if (pending.length === 0) return;

      const choice = pending[Math.floor(Math.random() * pending.length)];
      spawnCarieForCavity(choice.toothIndex, choice.cavityIndex, time);
    }

    // ----- COLISIONES -----
    function circleRectCollision(circle, rect) {
      // rect: {x,y,w,h} centrado
      const testX = Math.max(
        rect.x - rect.w / 2,
        Math.min(circle.x, rect.x + rect.w / 2)
      );
      const testY = Math.max(
        rect.y - rect.h / 2,
        Math.min(circle.y, rect.y + rect.h / 2)
      );
      const dx = circle.x - testX;
      const dy = circle.y - testY;
      return dx * dx + dy * dy < circle.r * circle.r;
    }

    function rectRectCollision(a, b) {
      return !(
        a.x + a.w / 2 < b.x - b.w / 2 ||
        a.x - a.w / 2 > b.x + b.w / 2 ||
        a.y + a.h / 2 < b.y - b.h / 2 ||
        a.y - a.h / 2 > b.y + b.h / 2
      );
    }

    // ----- FIN DE JUEGO -----
    function allCavitiesFilled() {
      return teeth.every(tooth =>
        tooth.cavities.every(cavity => cavity.filled)
      );
    }

    function endGame(win) {
      running = false;
      overlayTitle.textContent = win ? '¬°Nivel completado!' : 'Game Over';
      overlayMsg.textContent = win
        ? 'Todas las caries fueron rellenadas con resina. Dientes perfectos üòÅü¶∑'
        : 'Algunas caries llegaron a los dientes. Int√©ntalo otra vez y protege esa sonrisa.';
      overlay.classList.add('visible');
    }

    // ----- DIBUJO -----
    function drawBackground(time) {
      ctx.fillStyle = '#050816';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // "part√≠culas" tipo brillo cl√≠nico
      for (let i = 0; i < 40; i++) {
        const x = (i * 97) % canvas.width;
        const y = (i * 151 + time * 0.04) % canvas.height;
        ctx.fillStyle = i % 2 === 0 ? '#74b9ff' : '#ffeaa7';
        ctx.fillRect(x, y, 2, 2);
      }

      // l√≠nea que separa enc√≠a
      ctx.fillStyle = '#c44569';
      ctx.fillRect(0, canvas.height - 120, canvas.width, 8);
      ctx.fillStyle = '#f8e0d4';
      ctx.fillRect(0, canvas.height - 112, canvas.width, 20);
    }

    function drawTeeth() {
      teeth.forEach(tooth => {
        // diente base
        ctx.save();
        ctx.translate(tooth.x, tooth.y);
        ctx.fillStyle = '#f5f6fa';
        ctx.beginPath();
        ctx.moveTo(-tooth.w / 2, 0);
        ctx.lineTo(-tooth.w * 0.6, tooth.h);
        ctx.lineTo(tooth.w * 0.6, tooth.h);
        ctx.lineTo(tooth.w / 2, 0);
        ctx.closePath();
        ctx.fill();

        // contorno suave
        ctx.strokeStyle = '#dcdde1';
        ctx.lineWidth = 2;
        ctx.stroke();

        // resinas blancas (cavidades rellenadas)
        tooth.cavities.forEach(cavity => {
          if (!cavity.filled) return;
          let radius =
            cavity.size === 'small'
              ? 4
              : cavity.size === 'medium'
              ? 7
              : 10;
          const offsetY =
            cavity.size === 'small'
              ? 12
              : cavity.size === 'medium'
              ? 18
              : 24;
          ctx.fillStyle = '#ffffff';
          ctx.beginPath();
          ctx.arc(cavity.offsetX, offsetY, radius, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#dfe4ea';
          ctx.lineWidth = 1;
          ctx.stroke();
        });

        ctx.restore();
      });
    }

    function drawPlayer() {
      ctx.save();
      ctx.translate(player.x, player.y);

      // cuerpo de la "pistola de resina"
      ctx.fillStyle = '#00cec9';
      ctx.fillRect(-16, -8, 32, 18);

      // boquilla
      ctx.fillStyle = '#ffeaa7';
      ctx.fillRect(12, -4, 12, 10);

      // mango
      ctx.fillStyle = '#0984e3';
      ctx.fillRect(-8, 10, 16, 14);

      ctx.restore();
    }

    function drawBullets() {
      ctx.fillStyle = '#ffeaa7';
      bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function drawCaries(time) {
      caries.forEach(c => {
        const t = time / 350 + c.phase;
        c.x = c.baseX + Math.sin(t) * c.amp;

        ctx.fillStyle = '#1e272e';
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fill();

        // brillo malo
        ctx.fillStyle = '#485460';
        ctx.beginPath();
        ctx.arc(c.x - c.r / 3, c.y - c.r / 3, c.r / 3, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // ----- UPDATE -----
    function update(dt, time) {
      // controles (teclado + t√°ctil)
      let dir = 0;
      if (keys['ArrowLeft'] || keys['a'] || keys['A'] || moveLeft) dir -= 1;
      if (keys['ArrowRight'] || keys['d'] || keys['D'] || moveRight) dir += 1;
      player.x += dir * PLAYER_SPEED;
      if (player.x < 20) player.x = 20;
      if (player.x > canvas.width - 20) player.x = canvas.width - 20;

      if (keys[' '] || keys['Space'] || shooting) {
        shoot(time);
      }

      trySpawnCarie(time);

      // balas
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.y -= b.speed;
        if (b.y < -20) bullets.splice(i, 1);
      }

      // caries
      for (let i = caries.length - 1; i >= 0; i--) {
        const c = caries[i];
        c.y += c.speed * dt * 0.1;

        const tooth = teeth[c.toothIndex];

        // lleg√≥ al diente
        const toothRect = {
          x: tooth.x,
          y: tooth.y + tooth.h / 2,
          w: tooth.w,
          h: tooth.h
        };

        if (circleRectCollision({ x: c.x, y: c.y, r: c.r }, toothRect)) {
          // da√±o
          caries.splice(i, 1);
          tooth.cavities[c.cavityIndex].activeCarieId = null;
          lives--;
          updateHUD();
          if (lives <= 0) {
            endGame(false);
            return;
          }
          continue;
        }

        // choque con jugador (no obligatorio pero lo ponemos)
        const playerRect = {
          x: player.x,
          y: player.y,
          w: player.w,
          h: player.h
        };
        if (
          circleRectCollision({ x: c.x, y: c.y, r: c.r }, playerRect)
        ) {
          caries.splice(i, 1);
          teeth[c.toothIndex].cavities[c.cavityIndex].activeCarieId = null;
          lives--;
          updateHUD();
          if (lives <= 0) {
            endGame(false);
            return;
          }
          continue;
        }
      }

      // colisi√≥n bala‚Äìcarie
      for (let i = caries.length - 1; i >= 0; i--) {
        const c = caries[i];
        let destroyed = false;
        for (let j = bullets.length - 1; j >= 0; j--) {
          const b = bullets[j];
          if (
            circleRectCollision(
              { x: b.x, y: b.y, r: b.r },
              { x: c.x, y: c.y, w: c.r * 2, h: c.r * 2 }
            )
          ) {
            destroyed = true;
            bullets.splice(j, 1);
            break;
          }
        }

        if (destroyed) {
          const tooth = teeth[c.toothIndex];
          const cavity = tooth.cavities[c.cavityIndex];
          cavity.filled = true;
          cavity.activeCarieId = null;
          caries.splice(i, 1);

          score += TARGET_SCORE_PER_CAVITY;
          updateHUD();

          if (allCavitiesFilled()) {
            endGame(true);
            return;
          }
        }
      }
    }

    // ----- LOOP -----
    function loop(time) {
      if (!running) return;
      if (!lastTime) lastTime = time;
      const dt = time - lastTime;
      lastTime = time;

      update(dt, time);
      drawBackground(time);
      drawTeeth();
      drawPlayer();
      drawBullets();
      drawCaries(time);

      requestAnimationFrame(loop);
    }

    // ----- INPUT TECLADO -----
    document.addEventListener('keydown', (e) => {
      keys[e.key] = true;
    });

    document.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    // ----- INPUT T√ÅCTIL (pointer) -----
    function attachButtonHold(btn, onChangeFlag) {
      btn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        onChangeFlag(true);
      });
      btn.addEventListener('pointerup', (e) => {
        e.preventDefault();
        onChangeFlag(false);
      });
      btn.addEventListener('pointerleave', (e) => {
        e.preventDefault();
        onChangeFlag(false);
      });
      btn.addEventListener('pointercancel', (e) => {
        e.preventDefault();
        onChangeFlag(false);
      });
    }

    attachButtonHold(btnLeft, (v) => { moveLeft = v; });
    attachButtonHold(btnRight, (v) => { moveRight = v; });
    attachButtonHold(btnShoot, (v) => { shooting = v; });

    // ----- REINICIAR -----
    restartBtn.addEventListener('click', () => {
      bullets = [];
      caries = [];
      createTeeth();
      createPlayer();
      score = 0;
      lives = LIVES_MAX;
      lastShoot = 0;
      lastGlobalSpawn = 0;
      running = true;
      overlay.classList.remove('visible');
      updateHUD();
      lastTime = performance.now();
      requestAnimationFrame(loop);
    });

    // ----- INICIO -----
    function init() {
      createTeeth();
      createPlayer();
      updateHUD();
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
